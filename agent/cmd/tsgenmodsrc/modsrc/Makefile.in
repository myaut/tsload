CC = cc
MKDIR = mkdir
CP = cp

TARGET = @MODNAME@@SHLIBSUFFIX@

SRC = @SOURCE_FILENAME@
INC = @HEADER_FILENAME@
OBJ = $(SRC:.c=@SHOBJSUFFIX@)

TSLOADPATH = @TSLOADPATH@
BUILDDIR = build/build/@MODNAME@/@MODNAME@
INCDIR = include
MODLOADDIR=@TS_INSTALL_MOD_LOAD@

CFLAGS = @CCFLAGS@ @SHCCFLAGS@ -I$(TSLOADPATH)/@TS_INSTALL_INCLUDE@ -I$(BUILDDIR)/$(INCDIR)/
LDFLAGS = @SHLINKFLAGS@ -L$(TSLOADPATH)/@TS_INSTALL_LIB@ @LIBS@

BUILDINC = $(addprefix $(BUILDDIR)/$(INCDIR)/,$(INC))
BUILDSRC = $(addprefix $(BUILDDIR)/,$(SRC))
BUILDOBJ = $(addprefix $(BUILDDIR)/,$(OBJ))
TARGETFILE = $(addprefix $(BUILDDIR)/,$(TARGET))
DESTFILE = $(addprefix $(TSLOADPATH)/$(MODLOADDIR)/,$(TARGET))

all: $(TARGETFILE)

$(BUILDDIR):
	$(MKDIR) -p $@

$(BUILDDIR)/$(INCDIR):
	$(MKDIR) -p $@

$(BUILDDIR)/%.c: %.c $(BUILDDIR)
	$(CP) $< $@

$(BUILDDIR)/$(INCDIR)/%.h: $(INCDIR)/%.h
	$(CP) $< $@

$(BUILDDIR)/%@SHOBJSUFFIX@: $(BUILDDIR)/%.c 
	$(CC) $(CFLAGS) -c $< -o $@

$(TARGETFILE): $(BUILDDIR)/$(INCDIR) $(BUILDINC) $(BUILDOBJ)
	$(CC) -o $(TARGETFILE) $(LDFLAGS) $(BUILDOBJ)

$(DESTFILE): $(TARGETFILE)
	$(CP) $< $@

clean:
	rm -rf $(BUILDDIR)
	
install: $(DESTFILE)